name: Simulate Infrastructure Drift

on:
  workflow_dispatch:
  schedule:
    # Run at random-ish times: Monday, Wednesday, Friday at different hours
    - cron: '30 3 * * 1'   # Monday 3:30 AM
    - cron: '15 14 * * 3'  # Wednesday 2:15 PM
    - cron: '45 9 * * 5'   # Friday 9:45 AM

jobs:
  simulate-drift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Simulate drift changes
        run: |
          # Find all terragrunt.hcl files (excluding cache directories)
          mapfile -t TG_FILES < <(find environments -name "terragrunt.hcl" -not -path "*/.terragrunt-cache/*")

          if [ ${#TG_FILES[@]} -eq 0 ]; then
            echo "No terragrunt.hcl files found"
            exit 1
          fi

          # Randomly decide how many files to modify (1-3)
          num_files=$(( (RANDOM % 3) + 1 ))
          echo "Will modify $num_files file(s)"

          # Shuffle and pick files
          readarray -t SHUFFLED < <(printf '%s\n' "${TG_FILES[@]}" | shuf -n $num_files)

          changes_made=0
          for file in "${SHUFFLED[@]}"; do
            echo "Processing: $file"

            # Generate random values
            random_suffix=$(openssl rand -hex 3)

            # Choose a random modification type (modify keepers that cause actual drift)
            mod_type=$(( RANDOM % 4 ))

            case $mod_type in
              0)
                # Modify instance_name (affects random_id.instance_id keeper)
                if grep -q "instance_name" "$file"; then
                  sed -i "s/\(instance_name[[:space:]]*=[[:space:]]*\)\"[^\"]*\"/\1\"instance-${random_suffix}\"/" "$file"
                  echo "  Modified instance_name to: instance-${random_suffix}"
                fi
                ;;
              1)
                # Modify resource_prefix (affects random_string.suffix keeper)
                if grep -q "resource_prefix" "$file"; then
                  sed -i "s/\(resource_prefix[[:space:]]*=[[:space:]]*\)\"[^\"]*\"/\1\"res-${random_suffix}\"/" "$file"
                  echo "  Modified resource_prefix to: res-${random_suffix}"
                fi
                ;;
              2)
                # Modify service_name (affects random_integer.port keeper)
                if grep -q "service_name" "$file"; then
                  sed -i "s/\(service_name[[:space:]]*=[[:space:]]*\)\"[^\"]*\"/\1\"svc-${random_suffix}\"/" "$file"
                  echo "  Modified service_name to: svc-${random_suffix}"
                fi
                ;;
              3)
                # Modify project_name (affects random_uuid.deployment_id keeper)
                if grep -q "project_name" "$file"; then
                  sed -i "s/\(project_name[[:space:]]*=[[:space:]]*\)\"[^\"]*\"/\1\"proj-${random_suffix}\"/" "$file"
                  echo "  Modified project_name to: proj-${random_suffix}"
                fi
                ;;
            esac

            changes_made=$((changes_made + 1))
          done

          echo ""
          echo "Total changes made: $changes_made"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes to commit
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git add -A
          git commit -m "chore: simulate infrastructure drift

          Automated drift simulation for demo purposes.
          This change will cause Terraform to detect configuration drift.

          Generated by simulate-drift workflow"

          git push
